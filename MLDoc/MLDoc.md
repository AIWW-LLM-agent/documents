# ML System Design Doc - [RU]

## Дизайн агентной системы на основе LLM для предоставления данных о работе агрохолдинга

## Бизнес-цель

Улучшение доступа к информации в телеграм-каналах через автоматизированный поиск ответов с
помощью чат-бота.

### Проблематика

- Накопление повторных вопросов от пользователей, перегружающих поддержку.
- Недостаточная видимость старых, но релевантных постов для пользователей.
- Долгий процесс поиска и отсутсвие хорошей системы поиска внутри телеграмма.

### Преимущества использования ML

Использование современных LLM для автоматизации семантического поиска в большом объеме
текстовой информации.
Суммаризация и предоставление релевантных ответов без необходимости ручного поиска.

### Критерии успеха:

Интеграция бота в активные телеграм-каналы и обеспечение пользователей ответами на вопросы
с помощью бота.
Пользователи находят ответы на свои вопросы в нашем телеграм боте.

### Пользовательские потребности (исходя из USM и CJM)

- Разрешение пользовательской необходимости в быстром и точном поиске информации внутри
  телеграм-каналов.
- Уменьшение количества повторных вопросов, загружающих поддержку, и предоставление
  пользователю возможности самостоятельного поиска нужной информации.
- Поддержание вовлеченности пользователя за счет удобства и быстроты обнаружения
  релевантной информации.

### Ожидаемый пользовательский опыт

- Пользователи смогут легко и интуитивно задавать вопросы и получать ответы, что
  улучшит их общее впечатление от использования телеграм-каналов.
- Ответы будут предоставлены в формате, который легко ассимилируется и понимается
  пользователями.

## Бизнес-требования и ограничения

### Краткое описание бизнес требований

- Разработка интуитивно понятного интерфейса для задавания вопросов в чате.
- Создание системы для автоматического отвечания на вопросы на основе данных из
  социальных сетей.
- Интеграция с основными социальными платформами с акцентом на экономию времени и
  повышение вовлеченности пользователей.
- Соблюдение правил конфиденциальности и данных, включая GDPR.

### Итерации проекта

**Первая итерация:**
Прототипирование основного функционала для демонстрации возможности системы.
**Вторая итерация:**
Разработка POC для тестирования в контролируемой среде на подмножестве вопросов.
Бот должен уметь отвечать на релевантные вопросы в формате естественного текста и

# TODO - дописать

**Третья итерация:**

### Критерии успеха и возможные пути развития проекта

Снижение числа повторных вопросов и повышение качества ответов.
Развитие: расширение функциональности, поддержка новых платформ, улучшение алгоритмов.
1.3. Что входит в скоуп проекта/итерации, что не входит
Какие БТ будут покрыты с технической точки зрения за первую итерацию:
Интеграция с API для анализа и классификации запросов пользователей на естественном языке.
Реализация базы данных для хранения и извлечения данных с использованием chroma db.
Разработка и тестирование алгоритма поиска для эффективного нахождения релевантных
ответов.
Что не будет закрыто:
Ограниченная интеграция с социальными платформами, сосредоточенная только на основных
платформах.
Итерационная оптимизация производительности: начальные версии могут не поддерживать полный
объем запросов.
Неполная асинхронность обработки запросов и масштабирование системы.
Какие БТ будут покрыты с технической точки зрения за вторую итерацию:
Создание диалоговой системы, чат-бота с RAG и Memory
Ассинхронность запросов
Ручной фрод аккаунтов (Админка)
Какие БТ будут покрыты с технической точки зрения за третью итерацию:
Интент комманды
Поиск без указания канала или ресурса
Автоматический фрод аккаунтов или запросов
Описание результата с точки зрения качества кода и воспроизводимости
Код
Соответствие стандартам чистого кода и PEP8, использование Numpy Docstring для
документирования.
Применение pre-commit-hooks для автоматической проверки кода RUFF.
Все тесты в GitHub actions должны быть пройдены.
RUFF ✅
Успешная установка зависимостей через Poetry и сборка виртуального окружения. ✅
Отсутствие конфликтов среды и пакетов, корректная сборка Dockerfile. ❌
Проведение нагрузочных тестов и асинхронная работа кода, проверка функциональности бота,
подключения к API и работоспособности баз данных. ❌
Все изменения кода подвергаются code review перед слиянием в основную ветку. ✅
Последовательность проверки кода:
Выбора задачи в todoist
Cоздания ветки в Git для этой задачи и ее выполнения
Pull request в Main с коротким описанием изменений
Код проверяет более опытный товарищ и после мерджит в Main или пишет какие коррективы
стоит еще внести
Задача закрывается как выполненая в todoist
Описание планируемого технического долга
Рассмотрение возможности интеграции с дополнительными API, включая OpenAI, для улучшения
функциональности и качества ответов. ❌
Исследование альтернативных сервисов социальных сетей и способов интеграции. ✅
Эксперименты с различными запросами и промптами для обучения модели, а так-же
токенайзерами и разбиением больших файлов. ❌

## Архитектура первого прототипа

Для проверки работоспособности идеи мы пришли к следующей архитектуры системы. На вход
мы принимаем один из 13 вопросов из тестового набора. Для прототипа мы приняли решение
считать, что входной вопрос валиден и достаточен. 

Далее мы проводим семантическое сопоставление с вопросами из тестовой выборки и получаем "
ключ" вопроса. Это представление не зависит от текста вопроса и уникально идентифицирует
вопрос среди всех доступных. Эта архитектура не предполагает ответы на неизвестные
вопросы.  

По ключу мы получаем список параметров, необходимых для ответа на вопрос и извлекаем 
эти сущности из текста вопроса. 

В рамках прототипа мы решили реализовать негибкую систему. Мы заранее создаем 
параметризованные функции, к которым мы можем обратиться. Так мы получим неглубокую 
таблицу, на который были проведены все трансформации и она готова для передачи в 
контекст llm для суммаризации в естественный язык.
Таким образом, в конце работы системы следующее состояние:

```json
{
  "original_question": "Какой гибрид пшеницы показал наибольшую урожайность в сезоне 2024?",
  "question_key": 2,
  "template_question": "Какой гибрид $crop_name$ показал наибольшую урожайность в сезоне $year$?",
  "extracted_parameters": {
    "crop_name": "пшеницы",
    "year": "2024"
  },
  "data_store_name": "crop_yield_statistics",
  "data_store_sql": "SELECT hi.variety, hi.productivity FROM history_items AS hi JOIN crops AS c ON hi.crop_id = c.id WHERE hi.year = 2024 AND c.name ILIKE '%пшеница%' AND hi.productivity IS NOT NULL",
  "analysis_query": "SELECT variety, productivity from crop_yield_statistics ORDER BY hi.productivity DESC LIMIT 1;",
  "natural_language_response": "Гибрид пшеницы с максимальной урожайностью в сезоне: 2024: Гибрид: Алексеич, Урожайность: 52.5 ц/га"
}
```

**Диаграмма архитектуры**
![diagram](media/img.png)

